{
  "snapshot_date": "2025-10-03T22:10:00Z",
  "project": {
    "name": "stalld",
    "description": "Linux starvation detection and avoidance daemon",
    "purpose": "Monitors CPU run queues for starving threads and boosts them using SCHED_DEADLINE or SCHED_FIFO",
    "primary_use_case": "DPDK deployments with isolated CPUs running single busy-loop RT tasks",
    "warning": "Not recommended for safety-critical systems"
  },
  "repository": {
    "path": "/nas/src/RedHat/gitlab/stalld/stalld.git",
    "current_branch": "tests",
    "main_branch": "main",
    "working_tree": "clean",
    "last_commits": [
      {
        "hash": "063e0dc6b873",
        "message": "docs: Add project rules and agent usage guidelines",
        "files_changed": 2,
        "lines_added": 49
      },
      {
        "hash": "72cea6af8463",
        "message": "tests: Add Phase 2 command-line option tests (8 new tests)",
        "files_changed": 9,
        "lines_added": 1733
      },
      {
        "hash": "b4e7cb812403",
        "message": "tests: Add comprehensive test suite with infrastructure and functional tests"
      },
      {
        "hash": "27fa8bb9f881",
        "message": "docs: add CLAUDE.md, .claude agents, and update .gitignore"
      },
      {
        "hash": "838e700ba979",
        "message": "add .cursor directory to .gitignore"
      }
    ]
  },
  "structure": {
    "source_code": {
      "directory": "src/",
      "files": [
        {
          "name": "stalld.c",
          "description": "Main daemon logic, entry point, boosting",
          "lines": 1218,
          "key_functions": ["main() at line 1121", "boost_with_deadline() at line 438", "check_starving_tasks() at line 616"]
        },
        {
          "name": "sched_debug.c",
          "description": "Procfs backend for parsing /proc|sys/.../sched/debug"
        },
        {
          "name": "queue_track.c",
          "description": "eBPF backend for BPF-based task tracking"
        },
        {
          "name": "utils.c",
          "description": "Utilities: logging, CPU parsing, argument parsing"
        },
        {
          "name": "throttling.c",
          "description": "RT throttling detection and control"
        }
      ]
    },
    "ebpf": {
      "directory": "bpf/",
      "files": ["stalld.bpf.c - BPF tracepoint programs for task tracking"]
    },
    "tests": {
      "directory": "tests/",
      "infrastructure": [
        "run_tests.sh - Main test runner with auto-discovery and color output",
        "helpers/test_helpers.sh - 20+ helper functions for test writing",
        "helpers/starvation_gen.c - Configurable starvation generator"
      ],
      "directories": ["functional/", "unit/", "integration/", "fixtures/", "results/"]
    },
    "documentation": [
      "CLAUDE.md - Comprehensive development guide",
      "README.md - Project overview",
      "tests/README.md - Test documentation",
      "tests/TODO.md - Test implementation plan",
      "man/stalld.8 - Man page"
    ],
    "configuration": [
      ".claude/rules - Agent usage guidelines",
      ".claude/agents/ - Custom agents",
      "systemd/stalld.service - systemd unit file",
      "systemd/stalld.conf - Configuration"
    ]
  },
  "test_suite": {
    "total_tests": 12,
    "total_lines": 2028,
    "test_cases": 50,
    "status": {
      "passing": 11,
      "failing": 1,
      "skipped": 0,
      "note": "test01.c fails without root privileges and RT throttling disabled"
    },
    "phases": {
      "phase_1_foundation": {
        "status": "complete",
        "tests": [
          "test01.c - Original starvation test (fixed with 7 critical bug fixes)",
          "test_foreground.sh - Foreground mode (-f)",
          "test_log_only.sh - Log-only mode (-l)",
          "test_logging_destinations.sh - Logging options (-v, -k, -s)"
        ]
      },
      "phase_2_command_line_options": {
        "status": "complete",
        "tests": [
          {
            "name": "test_cpu_selection.sh",
            "option": "-c/--cpu",
            "lines": 146,
            "test_cases": 6,
            "coverage": ["single CPU", "CPU lists", "ranges", "combined formats", "invalid CPUs"]
          },
          {
            "name": "test_starvation_threshold.sh",
            "option": "-t/--starving_threshold",
            "lines": 177,
            "test_cases": 4,
            "coverage": ["custom thresholds", "detection timing", "invalid values"]
          },
          {
            "name": "test_boost_period.sh",
            "option": "-p/--boost_period",
            "lines": 175,
            "test_cases": 6,
            "coverage": ["default/custom periods", "short/long periods", "invalid values"]
          },
          {
            "name": "test_boost_runtime.sh",
            "option": "-r/--boost_runtime",
            "lines": 203,
            "test_cases": 7,
            "coverage": ["custom runtimes", "runtime vs period validation", "invalid values"]
          },
          {
            "name": "test_boost_duration.sh",
            "option": "-d/--boost_duration",
            "lines": 186,
            "test_cases": 6,
            "coverage": ["short/long durations", "policy restoration verification"]
          },
          {
            "name": "test_force_fifo.sh",
            "option": "-F/--force_fifo",
            "lines": 244,
            "test_cases": 6,
            "coverage": ["SCHED_FIFO vs SCHED_DEADLINE", "single-threaded incompatibility", "FIFO emulation"]
          },
          {
            "name": "test_pidfile.sh",
            "option": "-P/--pidfile",
            "lines": 198,
            "test_cases": 7,
            "coverage": ["custom locations", "PID verification", "cleanup on shutdown"]
          },
          {
            "name": "test_affinity.sh",
            "option": "-a/--affinity",
            "lines": 214,
            "test_cases": 8,
            "coverage": ["CPU affinity using taskset and /proc", "persistence checks"]
          }
        ]
      },
      "phase_3_core_logic": {
        "status": "pending",
        "estimated_time": "2 weeks",
        "tests_planned": [
          "test_starvation_detection.sh",
          "test_runqueue_parsing.sh",
          "test_deadline_boosting.sh",
          "test_fifo_boosting.sh",
          "test_boost_restoration.sh",
          "test_task_merging.sh",
          "test_idle_detection.sh"
        ]
      },
      "phase_4_advanced_features": {
        "status": "pending",
        "estimated_time": "1.5-2 weeks",
        "tests_planned": [
          "test_single_threaded_mode.sh",
          "test_adaptive_mode.sh",
          "test_aggressive_mode.sh",
          "test_thread_ignore.sh",
          "test_process_ignore.sh",
          "test_backend_comparison.sh",
          "test_sched_debug_formats.sh"
        ]
      },
      "phase_5_integration": {
        "status": "pending",
        "estimated_time": "1-1.5 weeks"
      },
      "phase_6_polish": {
        "status": "pending",
        "estimated_time": "1 week"
      }
    }
  },
  "project_rules": {
    "file": ".claude/rules",
    "mandatory_agents": {
      "git_operations": {
        "agent": "git-scm-master",
        "use_for": [
          "Creating commits",
          "Organizing uncommitted changes",
          "Refactoring commit history",
          "Managing branches",
          "Any git workflow tasks"
        ]
      },
      "c_development": {
        "agent": "c-expert",
        "use_for": [
          "Analyzing C code",
          "Generating new C code",
          "Modifying existing C code",
          "Reviewing C code for bugs or improvements",
          "Optimizing C code performance",
          "Debugging C code issues"
        ]
      },
      "testing": {
        "agent": "test-specialist",
        "use_for": [
          "Creating new tests",
          "Modifying existing tests",
          "Reviewing test coverage",
          "Implementing TDD cycles",
          "Writing test infrastructure or helpers",
          "Debugging test failures",
          "Planning test strategies"
        ],
        "special_authority": "Has BLOCKING POWER for commits with insufficient test coverage"
      },
      "planning": {
        "agent": "plan-validator",
        "use_for": [
          "Planning next steps in the project",
          "Modifying the current plan (TODO.md)",
          "Reviewing implementation strategies",
          "Assessing project feasibility",
          "Validating timeline estimates",
          "Reviewing development roadmaps"
        ]
      }
    }
  },
  "build_status": {
    "stalld_binary": {
      "path": "./stalld",
      "size": "263KB",
      "built": true
    },
    "test_binaries": [
      "tests/test01 (52KB)",
      "tests/helpers/starvation_gen"
    ],
    "architecture": "Linux x86_64",
    "kernel_version": "6.15.9-201.fc42.x86_64"
  },
  "key_technical_details": {
    "backends": {
      "primary": "queue_track_backend (eBPF-based, default on x86_64/aarch64/s390x)",
      "fallback": "sched_debug_backend (procfs-based, for i686/powerpc/legacy kernels)"
    },
    "scheduling_policies": {
      "preferred": "SCHED_DEADLINE",
      "fallback": "SCHED_FIFO",
      "note": "Single-threaded mode only works with SCHED_DEADLINE"
    },
    "threading_modes": [
      "Single-threaded (default)",
      "Adaptive (spawns per-CPU threads when approaching threshold)",
      "Aggressive (-A flag, per-CPU threads from startup)"
    ],
    "requirements": {
      "rt_throttling": "Must be disabled (/proc/sys/kernel/sched_rt_runtime_us == -1)",
      "permissions": "Root required for most operations",
      "kernel": "3.10+ (older untested)"
    }
  },
  "recent_work": {
    "session_focus": "Phase 2 test implementation and project infrastructure",
    "accomplishments": [
      "Created 8 comprehensive command-line option tests",
      "Added ~1,700 lines of test code",
      "Established project rules for agent usage (.claude/rules)",
      "Updated CLAUDE.md with rules reference",
      "All Phase 2 tests passing (11/11 functional tests)",
      "Created mandatory agent guidelines for git, C development, testing, and planning"
    ],
    "commits_created": 2,
    "files_created": 9,
    "test_coverage_increase": "From 4 to 12 tests (50+ test cases total)"
  },
  "next_steps": {
    "immediate": "Phase 3: Core Logic Testing",
    "priority_tests": [
      "Starvation detection verification",
      "SCHED_DEADLINE boosting verification",
      "SCHED_FIFO boosting verification",
      "Task merging logic",
      "Idle detection"
    ],
    "estimated_completion": "6-7.5 weeks remaining for full test suite"
  },
  "important_notes": [
    "ALWAYS read .claude/rules at session start",
    "Use specialized agents per project rules",
    "test-specialist has blocking power for insufficient test coverage",
    "Phase 1 and Phase 2 complete, focus on Phase 3 next",
    "Test suite uses helper functions from test_helpers.sh",
    "All tests follow autotools convention: 0=pass, 1=fail, 77=skip"
  ]
}
